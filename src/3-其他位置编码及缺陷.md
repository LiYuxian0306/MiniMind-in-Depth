# ä¸€ã€positional encoding æ€ä¹ˆç”¨ï¼Ÿ  
$q_n = q, k_m = k$ (ä¸æ·»åŠ ä½ç½®ä¿¡æ¯)ï¼Œåˆ™ä¸¤è€…çš„æ³¨æ„åŠ›æƒé‡è®¡ç®—å¦‚ä¸‹ï¼š

$$
a_{m,n} = \frac{\exp\left(\frac{q_m^T k_n}{\sqrt{d}}\right)}{\sum_{j=1}^N \exp\left(\frac{q_m^T k_j}{\sqrt{d}}\right)} 
$$

æˆ‘ä»¬å®šä¹‰å¦‚ä¸‹å‡½æ•°ï¼Œè¯¥å‡½æ•°è¡¨ç¤ºå¯¹è¯å‘é‡ $q$ æ³¨å…¥ä½ç½®ä¿¡æ¯ $m$ï¼Œå¾—åˆ° $q_m$ï¼š

$$
q_m = f(q, m)
$$

åˆ™ $q_m$ ä¸ $k_n$ ä¹‹é—´çš„æ³¨æ„åŠ›æƒé‡å¯è¡¨ç¤ºä¸ºï¼š

$$
a_{m,n} = \frac{\exp\left(\frac{f(q,m)^T f(k,n)}{\sqrt{d}}\right)}{\sum_{j=1}^N \exp\left(\frac{f(q,m)^T f(k,j)}{\sqrt{d}}\right)}
$$



# äºŒã€ä¸åŒpositional encodingçš„æ¯”è¾ƒ
## 1. trainable positional encoding
é•¿åº¦å›ºå®š

## 2. sinusoidal positional encoding
### ï¼ˆ1ï¼‰Sinusoidal PEæ˜¯ä»€ä¹ˆï¼Ÿ
åœ¨TransformeråŸå§‹è®ºæ–‡ã€ŠAttention is All You Needã€‹ä¸­ï¼Œä½œè€…ä½¿ç”¨äº†å›ºå®šçš„**æ­£ä½™å¼¦ä½ç½®ç¼–ç **Sinusoidal PEæ¥ä¸ºæ¨¡å‹å¼•å…¥ä½ç½®ä¿¡æ¯ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯åˆ©ç”¨ä¸åŒé¢‘ç‡çš„æ­£å¼¦æ³¢å’Œä½™å¼¦æ³¢å¯¹æ¯ä¸ªä½ç½®è¿›è¡Œç¼–ç ï¼Œå…·ä½“å…¬å¼å¦‚ä¸‹ï¼š

$$
\begin{aligned}
\text{PE}_{(pos, 2i)} = \sin\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right) \\
\text{PE}_{(pos, 2i+1)} = \cos\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right)
\end{aligned}
$$

å…¶ä¸­ï¼Œ`pos`è¡¨ç¤º token åœ¨åºåˆ—ä¸­çš„ä½ç½®ï¼Œå–å€¼èŒƒå›´ä¸º [0, 1, 2, ..., seq_len-1]ï¼›`i`è¡¨ç¤º embedding çš„ç»´åº¦ç´¢å¼•ï¼ŒèŒƒå›´ä¸º $[0, 1, \dots, d_{\text{model}}/2 - 1]$ï¼Œ`i`çš„æ‰€æœ‰å–å€¼æ€»å…±æœ‰ $d_{\text{model}}/2$ ä¸ªï¼Œæ¯ä¸€ä¸ªéƒ½åˆ†åˆ«é€šè¿‡æ–½åŠ  sin æˆ– cos å˜æ¢æ¥å¯¹åº”æŸä¸ª token çš„ embedding ä¸åŒä½ç½®çš„å¶æ•°ç»´ä¸å¥‡æ•°ç»´ã€‚
$d_{\text{model}}$:embeddingç»´åº¦


ä¸ºäº†ä¾¿äºç†è§£ï¼Œè¿™é‡Œæ¥ä¸¾ä¸ªå®é™…çš„ä¾‹å­æ¥æ¼”ç¤ºæ­£ä½™å¼¦ä½ç½®ç¼–ç çš„å·¥ä½œåŸç†ã€‚

å‡è®¾ $d_{\text{model}}$ =8ï¼Œtokenåºåˆ—é•¿åº¦seq_len=120ï¼Œç°åœ¨éœ€è¦è®¡ç®—åºåˆ—ä¸­ç¬¬2ä¸ªä½ç½®ï¼ˆå³`pos`=2ï¼‰çš„tokenå¯¹åº”çš„ä½ç½®ç¼–ç ï¼Œå¥—å…¬å¼ï¼š

è®¡ç®—æ¯ä¸ªç»´åº¦çš„ç¼©æ”¾å› å­ï¼š
| i | ç»´åº¦ (2i / 2i+1)  | $\text{div\_term}_i = 10000^{\frac{2i}{d_{\text{model}}}}$ |
|---|------------------|------------------------------------|
| 0 | 0 / 1            | $10000^{0} = 1$                    |
| 1 | 2 / 3            | $10000^{0.25} \approx 10$          |
| 2 | 4 / 5            | $10000^{0.5} = 100$                |
| 3 | 6 / 7            | $10000^{0.75} \approx 1000$        |

å¸¦å…¥å…¬å¼è®¡ç®— PEï¼š

$$
\begin{aligned}
\text{PE}(2, 0) &= \sin(2/1) = \sin(2.0) \approx 0.9093 \\
\text{PE}(2, 1) &= \cos(2/1) = \cos(2.0) \approx -0.4161 \\
\text{PE}(2, 2) &= \sin(2/10) = \sin(0.2) \approx 0.1987 \\
\text{PE}(2, 3) &= \cos(2/10) = \cos(0.2) \approx 0.9801 \\
\text{PE}(2, 4) &= \sin(2/100) = \sin(0.02) \approx 0.0200 \\
\text{PE}(2, 5) &= \cos(2/100) = \cos(0.02) \approx 0.9998 \\
\text{PE}(2, 6) &= \sin(2/1000) = \sin(0.002) \approx 0.0020 \\
\text{PE}(2, 7) &= \cos(2/1000) = \cos(0.002) \approx 0.9999 \\
\end{aligned}
$$

---

æœ€ç»ˆä½ç½®ç¼–ç å‘é‡ï¼ˆpos = 2ï¼‰ä¸ºï¼š

[0.9093, -0.4161, 0.1987, 0.9801, 0.0200, 0.9998, 0.0020, 0.9999]

æ­£ä½™å¼¦ä½ç½®ç¼–ç çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š

```python
def sinusoidal_position_encoding(seq_len, d_model):
    """
    è®¡ç®—æ­£ä½™å¼¦ä½ç½®ç¼–ç ï¼ˆSinusoidal PEï¼‰ã€‚

    å‚æ•°ï¼š
    seq_len -- åºåˆ—é•¿åº¦
    d_model -- æ¨¡å‹çš„ç»´åº¦

    è¿”å›ï¼š
    è¿”å›ä¸€ä¸ªå½¢çŠ¶ä¸º (seq_len, d_model) çš„ä½ç½®ç¼–ç çŸ©é˜µ
    """
    # åˆ›å»ºä½ç½®ç¼–ç çŸ©é˜µ
    position = np.arange(seq_len)[:, np.newaxis]  # shapeä¸º (seq_len, 1)
    div_term = np.power(10000, (2 * (np.arange(d_model // 2)) / np.float32(d_model)))  # é¢‘ç‡ç¼©æ”¾å› å­

    # è®¡ç®—æ­£ä½™å¼¦ä½ç½®ç¼–ç 
    pe = np.zeros((seq_len, d_model))
    pe[:, 0::2] = np.sin(position / div_term)  # å¶æ•°ç»´åº¦ç”¨æ­£å¼¦
    pe[:, 1::2] = np.cos(position / div_term)  # å¥‡æ•°ç»´åº¦ç”¨ä½™å¼¦

    return pe

# ç¤ºä¾‹ï¼šè®¡ç®— seq_len=120ï¼Œd_model=8 çš„ä½ç½®ç¼–ç 
seq_len = 120
d_model = 8
pe = sinusoidal_position_encoding(seq_len, d_model)

print(pe.shape)# (120, 8)
```

#### ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿï¼ˆnewï¼‰
åœ¨[sinusoidal PE analysis](https://kazemnejad.com/blog/transformer_architecture_positional_encoding/) æ–‡ç« ä¸­ï¼Œæåˆ°äº†positional embeddingçš„å…¶ä»–è®¾è®¡æ€è·¯å’Œä¸ºä»€ä¹ˆé€‰å–æœ€ç»ˆçš„è¿™ä¸ªè®¾è®¡ã€‚

(1) $\text{PE}(i) = \frac{i}{\text{len}}$ è¿™é‡Œçš„ $i$ æŒ‡çš„æ˜¯ä¸€ä¸ª sequence é‡Œé¢çš„ä¸€ä¸ª token çš„ positionã€‚   
**æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ**

è¿™é‡Œçš„ PE åœ¨ä¸åŒçš„ sequence é•¿åº¦ä¸‹é¢æ˜¯ä¸ç»Ÿä¸€çš„ã€‚æ¯”å¦‚ä¸€ä¸ªé•¿ä¸º 4 çš„ sequence çš„ç¬¬ 2 ä¸ª token å’Œä¸€ä¸ªé•¿ä¸º 8 çš„ sequence çš„ç¬¬ 4 ä¸ª token å¯¹åº”çš„ PE æ˜¯ä¸€æ ·çš„ï¼Œè¿™ç§ä¸ä¸€è‡´ä¼šå¸¦æ¥é—®é¢˜ï¼›  
å°¤å…¶æ˜¯è€ƒè™‘åˆ°è®¡ç®—ä¸åŒä½ç½®çš„ token ä¹‹é—´çš„å…³ç³»çš„æ—¶å€™ï¼Œå¯¹äºä¸€ä¸ªé•¿ä¸º 4 çš„ sequenceï¼Œç›¸é‚»ä¸¤ä¸ª token çš„ PE å·®å€¼ä¸º 0.25ï¼Œå¯æ˜¯å¯¹äºä¸€ä¸ªé•¿ä¸º 10000 çš„ sequenceï¼Œè¿™ä¸ªå·®å€¼å°±æ˜¯ 0.0001ï¼Œå¾ˆæ˜æ˜¾æ¨¡å‹éš¾ä»¥å¯¹ä¸åŒé•¿åº¦çš„ sequence æ„ŸçŸ¥æ­£ç¡®çš„ä½ç½®å…³ç³»ã€‚

(2) $\text{PE}(i) = i$   
**æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ**  
å¦‚æœsequence_lenè¶…å‡ºè®­ç»ƒé•¿åº¦ï¼Œæ¨¡å‹å¯èƒ½ä¸èƒ½æ­£ç¡®æ•æ‰ä½ç½®ä¿¡æ¯  

**PEçš„ç†æƒ³ç‰¹å¾**ï¼š  
æ¯ä¸ªpositionå¯¹åº”çš„peæ˜¯ç‹¬ç‰¹çš„  
ä¸¤ä¸ªè·ç¦»ç›¸åŒçš„positionä¹‹é—´çš„è·ç¦»å¯¹äºä¸åŒé•¿åº¦çš„åºåˆ—æ¥è¯´åº”è¯¥æ˜¯å›ºå®šçš„
èƒ½å¤Ÿgeneralize to longer sequence 
deterministic  

### ï¼ˆ2ï¼‰Sinusoidal PEçš„ç‰¹å¾

#### a. ç›¸å¯¹ä½ç½®æ˜“æ„ŸçŸ¥ (new)

å¯¹äºä»»ä½•å›ºå®šçš„åç§»é‡ $k$ , ä½ç½® $t+k$ çš„ç¼–ç å‘é‡ $PE_{t+k}$ éƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªä¸ç»å¯¹ä½ç½® $t$ æ— å…³çš„æ—‹è½¬çŸ©é˜µä¹˜ä»¥ $PE_{t}$ å¾—åˆ°ã€‚è¿™é‡Œçš„ $PE_{t+k}$ æŒ‡çš„æ˜¯ä¸€ä¸ª sin-cos pairã€‚

**è¯æ˜ï¼š**

å®šä¹‰ä½ç½®ç¼–ç å¦‚ä¸‹ï¼š

$$
\begin{aligned}
\text{PE}(t, 2i) &= \sin(\omega_i \cdot t) \\
\text{PE}(t, 2i+1) &= \cos(\omega_i \cdot t)
\end{aligned}
$$

å…¶ä¸­é¢‘ç‡ $\omega_i$ å®šä¹‰ä¸ºï¼š

$$
\omega_i = \frac{1}{10000^{2i/d}}
$$

1. **æ­£å¼¦å±•å¼€**ï¼š

$$
\sin(\omega_i (t+k)) = \sin(\omega_i t + \omega_i k) = \sin(\omega_i t)\cos(\omega_i k) + \cos(\omega_i t)\sin(\omega_i k)
$$

2. **ä½™å¼¦å±•å¼€**ï¼š

$$
\cos(\omega_i (t+k)) = \cos(\omega_i t + \omega_i k) = \cos(\omega_i t)\cos(\omega_i k) - \sin(\omega_i t)\sin(\omega_i k)
$$


å°†å…¶å†™æˆçŸ©é˜µå½¢å¼ï¼š    

$$
\begin{bmatrix} 
\sin(\omega_i (t+k)) \\ 
\cos(\omega_i (t+k)) 
\end{bmatrix} = 
\begin{bmatrix} 
\cos(\omega_i k) & \sin(\omega_i k) \\ 
-\sin(\omega_i k) & \cos(\omega_i k) 
\end{bmatrix} 
\cdot 
\begin{bmatrix} 
\sin(\omega_i t) \\ 
\cos(\omega_i t) 
\end{bmatrix}
$$

æ‰€ä»¥ï¼š

$$
\vec{p_{t+k}} = M_k \cdot \vec{p_t}
$$

å…¶ä¸­æ—‹è½¬çŸ©é˜µ $M_k$ ä¸ºï¼š

$$
M_k = \begin{bmatrix} \cos(\omega_i k) & \sin(\omega_i k) \\ -\sin(\omega_i k) & \cos(\omega_i k) \end{bmatrix}
$$

#### b. è¿œç¨‹è¡°å‡ç‰¹æ€§

##### <1> å®šä¹‰ä½ç½®å‘é‡
å¯¹äºç»´åº¦ $d$ çš„ä½ç½®ç¼–ç ï¼Œç¬¬ $i$ å¯¹åˆ†é‡ï¼ˆç´¢å¼• $2i$ å’Œ $2i+1$ï¼‰å¯¹åº”çš„é¢‘ç‡ä¸º $\omega_i = \frac{1}{10000^{2i/d}}$ã€‚
ä½ç½® $t$ çš„å‘é‡è¡¨ç¤ºä¸ºï¼š

$$
\begin{aligned}
PE(t)_{2i} &= \sin(\omega_i t) \\
PE(t)_{2i+1} &= \cos(\omega_i t)
\end{aligned}
$$

##### <2> è®¡ç®—ç›¸å¯¹ä½ç½®å†…ç§¯
è®¡ç®—ä½ç½® $t$ å’Œä½ç½® $t+k$ ï¼ˆç›¸å¯¹è·ç¦»ä¸º $k$ï¼‰çš„å†…ç§¯ï¼š

$$
PE(t) \cdot PE(t+k) = \sum_{i=0}^{d/2 - 1} \left[ \sin(\omega_i t)\sin(\omega_i (t+k)) + \cos(\omega_i t)\cos(\omega_i (t+k)) \right]
$$

åˆ©ç”¨ä¸‰è§’æ’ç­‰å¼ $\cos(A - B) = \cos A \cos B + \sin A \sin B$ï¼Œä¸Šè¿°å…¬å¼åŒ–ç®€ä¸ºï¼š

$$
PE(t) \cdot PE(t+k) = \sum_{i=0}^{d/2 - 1} \cos\big(\omega_i (t+k) - \omega_i t\big) = \sum_{i=0}^{d/2 - 1} \cos(\omega_i k)
$$

##### <3> ä»å…¬å¼çœ‹è¡°å‡æ€§è´¨
å†…ç§¯æœ€ç»ˆå˜æˆäº†**ä¸åŒé¢‘ç‡ä½™å¼¦å‡½æ•°çš„å åŠ å’Œ**ï¼š $S(k) = \sum \cos(\omega_i k)$ ã€‚

*   **å½“ k=0 (è‡ªèº«å†…ç§¯):**  

$$
\sum \cos(0) = \sum 1 = d/2
$$  

    æ­¤æ—¶æ‰€æœ‰åˆ†é‡åŒç›¸ï¼Œå–æœ€å¤§å€¼ã€‚

*   **å½“ k å¢å¤§ (è¿œç¨‹):**
    *   **é«˜é¢‘åˆ†é‡**ï¼ˆ $\omega_i$ è¾ƒå¤§ï¼‰ï¼š $\omega_i k$ å˜åŒ–å‰§çƒˆï¼Œ $\cos(\omega_i k)$ åœ¨ [-1, 1] ä¹‹é—´å¿«é€Ÿéœ‡è¡ã€‚è¿™äº›é¡¹åœ¨æ±‚å’Œæ—¶ä¼šå‘ç”Ÿ**ç›¸æ¶ˆå¹²æ¶‰**ï¼Œå¹³å‡è´¡çŒ®è¶‹è¿‘äº 0ã€‚
    *   **ä½é¢‘åˆ†é‡**ï¼ˆ $\omega_i$ è¾ƒå°ï¼‰ï¼šåªæœ‰æå°‘æ•°é¢‘ç‡æä½çš„åˆ†é‡è¿˜èƒ½ä¿æŒ $\cos(\omega_i k) > 0$ã€‚

**ç»“è®ºï¼š** éšç€ $k$ å˜å¤§ï¼Œæ­£å‘è´¡çŒ®çš„é¡¹è¶Šæ¥è¶Šå°‘ï¼Œäº’ç›¸æŠµæ¶ˆçš„é¡¹è¶Šæ¥è¶Šå¤šï¼Œå¯¼è‡´æ€»å’Œ $S(k)$ çš„åŒ…ç»œçº¿å‘ˆç°ä¸‹é™è¶‹åŠ¿ï¼ˆå³è¿œç¨‹è¡°å‡ï¼‰ã€‚

#### c. embedding positionå¢å¤§ï¼Œå˜åŒ–å°ºåº¦å‡å°
> æ­¤éƒ¨åˆ†è¢«åŸä½œè€…å–åä¸ºâ€œè¿œç¨‹è¡°å‡ç‰¹æ€§â€ï¼Œä½†æ˜¯æ„Ÿè§‰ç†è§£ä¸Šå¯èƒ½ç¨å¾®æœ‰ç‚¹ä¸å¤ªæ˜ç¡®ï¼Œæ‰€ä»¥æ›´æ”¹äº†ä¸€ä¸‹åå­—

æ­£ä½™å¼¦ä½ç½®ç¼–ç ä¸éœ€è¦å­¦ä¹ å‚æ•°ï¼ŒèŠ‚çœäº†è®¡ç®—èµ„æºå’Œå­˜å‚¨ç©ºé—´ã€‚ä¸¤è€…çš„ç»„åˆèƒ½å¤Ÿå¹³æ»‘è¿‡æ¸¡ï¼Œé€‚åˆå»ºæ¨¡åºåˆ—ä¸­çš„ä½ç½®å…³ç³»ï¼Œå¹¶æ•æ‰tokenä¹‹é—´çš„ç›¸å¯¹ä½ç½®å·®å¼‚ã€‚

æ­£ä½™å¼¦ä½ç½®ç¼–ç å…·æœ‰è¿œç¨‹è¡°å‡çš„ç‰¹æ€§ï¼šå¯¹äºä¸€ä¸ªåºåˆ—ä¸­æ¯ä¸ªtokençš„å‘é‡ï¼Œåœ¨å¯¹æ¯ä¸ªtokenæ–½åŠ sin PEæ—¶ï¼Œä»åºåˆ—tokenè§†è§’æ¥çœ‹ï¼Œæ¯ä¸ªtokenå‘é‡çš„ä½ç»´å…ƒç´ (iè¾ƒå°)åœ¨ç›¸é‚»tokenä¹‹é—´çš„å˜åŒ–æ¯”è¾ƒå¿«ï¼Œè€Œé«˜ç»´(iè¾ƒå¤§)åˆ™æ¯”è¾ƒæ…¢ã€‚

ä¸‹é¢æ¥æ¨å¯¼ä¸€ä¸‹è¿™ä¸ªç»“è®ºï¼Œå›çœ‹å…¶æ•°å­¦è®¡ç®—å…¬å¼:

$$
\text{PE}_{(pos, 2i)} = \sin\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right) \\
\text{PE}_{(pos, 2i+1)} = \cos\left(\frac{pos}{10000^{2i/d_{\text{model}}}}\right)
$$

å¯ä»¥å‘ç°ï¼Œéšç€ $i$ å¢å¤§ï¼ˆå³embeddingç»´åº¦å¢å¤§ï¼‰ï¼Œæ¯ä¸ªç»´åº¦çš„é¢‘ç‡ $\frac{pos}{10000^{2i/d_{\text{model}}}}$ æ˜¯å‡å°çš„ï¼Œå¯¼è‡´ä½ç½®ç¼–ç åœ¨é«˜ç»´åº¦ä¸‹ï¼ˆå³iè¾ƒå¤§ï¼‰çš„å˜åŒ–å˜å¾—ç¼“æ…¢ã€‚å³ï¼Œç›¸é‚»ä½ç½®çš„ç¼–ç å·®å¼‚å˜å¾—éå¸¸å°ï¼Œç›´åˆ°è¿™äº›ä½ç½®çš„ç¼–ç å‡ ä¹è¶‹äºç›¸åŒã€‚

åŒæ—¶ï¼Œå¦‚æœtokenåºåˆ—é•¿åº¦éå¸¸é•¿ï¼Œéšç€`pos`å€¼çš„å¢å¤§ï¼Œä½ç½®ç¼–ç çš„å˜åŒ–å˜å¾—è¶Šæ¥è¶Šå¹³ç¼“ï¼Œå°¤å…¶æ˜¯é«˜ç»´åº¦çš„éƒ¨åˆ†(å³iè¾ƒå¤§)ï¼Œä½ç½®ä¹‹é—´çš„å·®å¼‚å˜å¾—éå¸¸å¾®å°ã€‚

ä½ å¯èƒ½ä¼šç–‘æƒ‘ï¼Œ`pos`å€¼å¢å¤§ä¸æ˜¯ä¹Ÿå¯ä»¥ä½¿å¾—é¢‘ç‡é¡¹å¢å¤§å—ï¼Ÿæ³¨æ„è¿™é‡ŒæŒ‡çš„æ˜¯ä¸åŒ`pos`ä½ç½®ä¹‹é—´çš„å·®å¼‚ä¼šéšç€`pos`å€¼çš„å¢å¤§è€Œå‡å°ï¼Œå› ä¸ºä¸¤ä¸ªç›¸é‚»`pos`ä½ç½®çš„å·®å¼‚åœ¨åˆ†å­ä¸Šä»…ä»…ä¸º1ï¼Œè€Œåˆ†æ¯æ˜¯æŒ‡æ•°çº§å¢é•¿(2çš„å¹‚æ¬¡)ï¼å¥—å…¥å…¬å¼è®¡ç®—å°±å¯ä»¥çœ‹åˆ°ï¼Œ`i`å’Œ`pos`è¾ƒå¤§æ—¶ä¸¤è€…çš„å·®å¼‚éå¸¸å¾®å°ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ $d_{\text{model}} = 512$ï¼Œ$i = 256$ ï¼Œæ‰€ä»¥åˆ†æ¯ä¸º $\frac{1}{10000^1} = 10^{-4}$ ã€‚è€ƒè™‘ä¸¤ä¸ªä½ç½®ï¼špos = 1000 å’Œ pos = 1001ï¼Œè®¡ç®—ä¸¤è€…ç¼–ç å·®å€¼ï¼š
   
$$
\Delta = \sin(10^{-4} \cdot 1001) - \sin(10^{-4} \cdot 1000)
$$

ä¹Ÿå°±æ˜¯ï¼š

$$
\Delta = \sin(0.1001) - \sin(0.1000) \approx 0.0998337 - 0.0998334 = 0.0000003
$$

ç»“æœå·®å€¼æå°ï¼Œè¯´æ˜å³ä½¿ä½ç½®å·®å¼‚ä¸º 1ï¼Œé«˜ç»´ç¼–ç ä¹Ÿå‡ ä¹ä¸å˜ã€‚

ä¸ºäº†è¿›ä¸€æ­¥éªŒè¯è¿™ä¸€ç‚¹ï¼Œè¿™é‡Œç»˜åˆ¶åœ¨ä¸åŒçš„å›ºå®šiå–å€¼ä¸‹ï¼Œposçš„å˜åŒ–è¶‹åŠ¿ï¼š
```python
import numpy as np
import matplotlib.pyplot as plt

def sinusoidal_position_encoding(seq_len, d_model):
    """
    è®¡ç®—æ­£ä½™å¼¦ä½ç½®ç¼–ç ï¼ˆSinusoidal PEï¼‰ã€‚
    å‚æ•°ï¼š
        seq_len -- åºåˆ—é•¿åº¦
        d_model -- æ¨¡å‹çš„ç»´åº¦
    è¿”å›ï¼š
        ä¸€ä¸ªå½¢çŠ¶ä¸º (seq_len, d_model) çš„ä½ç½®ç¼–ç çŸ©é˜µ
    """
    position = np.arange(seq_len)[:, np.newaxis]  # (seq_len, 1)
    div_term = np.power(10000, (2 * (np.arange(d_model // 2)) / np.float32(d_model)))  # (d_model/2,)

    pe = np.zeros((seq_len, d_model))
    pe[:, 0::2] = np.sin(position / div_term)  # å¶æ•°ç»´åº¦ä½¿ç”¨æ­£å¼¦
    pe[:, 1::2] = np.cos(position / div_term)  # å¥‡æ•°ç»´åº¦ä½¿ç”¨ä½™å¼¦

    return pe

# å‚æ•°è®¾ç½®
seq_len = 512  # åºåˆ—é•¿åº¦
d_model = 128  # æ¨¡å‹çš„ç»´åº¦

# è·å–ä½ç½®ç¼–ç 
pe = sinusoidal_position_encoding(seq_len, d_model)

plt.figure(figsize=(10, 6))
fixed_pos = 10  # å›ºå®šä½ç½®
for i in [0,32,64]:  # æ¯6ä¸ªç»´åº¦å±•ç¤ºä¸€ä¸ª
    plt.plot(np.arange(seq_len), pe[:, i], label=f'i={i}')
plt.xlabel("Position (pos)")
plt.ylabel("Position Encoding Value")
plt.title(f"Position Encoding at Fixed Position {fixed_pos} (Frequency Decrease with i)")
plt.legend(loc='upper right')
plt.tight_layout()
plt.show()
```
![](1.png)

xè½´æ˜¯ä¸åŒçš„posï¼Œyè½´æ˜¯ç›¸åº”posä¸‹æœ€ç»ˆä½ç½®ç¼–ç çš„å…ƒç´ å€¼ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå½“i=0ï¼ˆè¾ƒå°ï¼‰æ—¶ï¼Œéšç€posçš„å¢å¤§ï¼Œç›¸é‚»posä¹‹é—´çš„å·®å¼‚å˜åŒ–å¹…åº¦è¾ƒå¤§ï¼Œè€Œéšç€iå˜å¤§ï¼Œæ¯”å¦‚i=64æ—¶ï¼Œç›¸é‚»posä¹‹é—´çš„å·®å¼‚éå¸¸å°ã€‚

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“i=64ï¼ˆè¾ƒå¤§ï¼‰æ—¶ï¼Œå³ä½¿posä»10å¢åˆ°20ï¼Œyè½´å¯¹åº”çš„å€¼å˜åŒ–ä¹Ÿä¸å¤§ï¼Œè¿™ç§ç»†å¾®çš„å˜åŒ–éš¾ä»¥è¢«æ¨¡å‹æ„ŸçŸ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“åºåˆ—å˜é•¿ï¼ˆseq_lengthè¾ƒå¤§ï¼‰ï¼Œè¿œè·ç¦»(è¾ƒå¤§çš„i)ç›¸é‚»tokenå¯¹åº”å…ƒç´ ä¹‹é—´çš„å·®å¼‚ä¼šå˜å¾—ä¸æ˜æ˜¾ã€‚

> ä¸€äº›é—®é¢˜ï¼š
> 1. è¿™é‡Œæåˆ°çš„â€œå·®å¼‚â€æ˜¯æ•°å€¼ä¸Šé¢çš„å·®å¼‚ï¼Œè€Œä¸æ˜¯æ¯”ä¾‹æ–¹é¢çš„å·®å¼‚ï¼ˆæ¯”ä¾‹æ–¹é¢çš„åœ¨ä¸Šé¢å·²ç»è¯æ˜ä¸ä¼šå˜äº†ï¼‰ã€‚é‚£ä¹ˆï¼Œæ¨¡å‹åœ¨æ•æ‰çš„æ—¶å€™ï¼Œåˆ°åº•æ˜¯æ•æ‰çº¿æ€§å˜åŒ–æ¯”è¾ƒç²¾å‡†ï¼Œè¿˜æ˜¯æ•æ‰æ¯”ä¾‹å˜åŒ–æ¯”è¾ƒç²¾å‡†ï¼Ÿ
> 2. è¿™é‡Œçš„è¿™ç§â€œè¡°å‡â€çœŸçš„æ˜¯ä¸å¥½çš„å—ï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ—¢ç„¶ä¸‹æ–‡æåˆ°äº†RoPEç»§æ‰¿äº†è¿™ç§è¡°å‡ï¼Œé‚£ä¹ˆRoPEçœŸçš„æœ‰è§£å†³è¿™ä¸ªé—®é¢˜å—ï¼Ÿ
> 3. ğŸ¤” åœ¨**ç›¸å¯¹ä½ç½®æ˜“æ„ŸçŸ¥**éƒ¨åˆ†ï¼Œå…¶å®æŠŠ $\omega_i$ å»æ‰ï¼Œä¼šå‘ç°å…¶å®ç›´æ¥ç”¨ $\sin\left(\frac{pos}{h}\right)$ å’Œ $\cos\left(\frac{pos}{h}\right)$ ï¼ˆhæ˜¯ä¸€ä¸ªè¶³å¤Ÿå¤§çš„æ•°ï¼‰å…¶å®ä¹Ÿèƒ½å®ç°ã€‚é‚£ä¹ˆï¼Œè¿™é‡Œåˆ°åº•ä¸ºä»€ä¹ˆè¦é™¤ä»¥ $\omega_i$ ï¼Ÿç‰¹å¾ç»´åº¦çš„positionåˆ°åº•ä¸ºä»€ä¹ˆè¦è¢«è€ƒè™‘å’Œè®¡ç®—ï¼Ÿ

##### å¦å¤–ä¸€ç§ç†è§£å½¢å¼æ˜¯ä¸æ˜¯ä¼šæ›´åˆç†ï¼Ÿ
æ­£å¼¦/ä½™å¼¦ç¼–ç æœ¬è´¨ä¸Šæ˜¯å°†ä¸€ä¸ªæ ‡é‡ä½ç½® $pos$ æ˜ å°„ï¼ˆProjectï¼‰ åˆ°ä¸€ä¸ª $d_{model}$ ç»´çš„é«˜ç»´ç©ºé—´ä¸­ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼šæ¯ä¸ªç»´åº¦ä»£è¡¨ä¸€ä¸ªä¸åŒçš„é¢‘ç‡ã€‚

ä½é¢‘ç»´åº¦ï¼ˆ $i$ è¾ƒå°ï¼‰ï¼šæ³¢é•¿å¾ˆé•¿ï¼Œå˜åŒ–å¾ˆæ…¢ï¼Œç”¨æ¥æ•æ‰é•¿è·ç¦»çš„ä½ç½®å…³ç³»ï¼ˆæ¯”å¦‚æ–‡ç« å¼€å¤´å’Œç»“å°¾ï¼‰ã€‚  

é«˜é¢‘ç»´åº¦ï¼ˆ $i$ è¾ƒå¤§ï¼‰ï¼šæ³¢é•¿å¾ˆçŸ­ï¼Œå˜åŒ–å¾ˆå¿«ï¼Œç”¨æ¥æ•æ‰å±€éƒ¨çš„ä½ç½®å…³ç³»ï¼ˆæ¯”å¦‚ç›¸é‚»è¯çš„é¡ºåºï¼‰ã€‚

### 3. Sinusoidal PEçš„ç¼ºé™·

æ­£ä½™å¼¦ä½ç½®ç¼–ç çš„æœ€å¤§ç¼ºé™·åœ¨äºï¼Œå®ƒåªèƒ½æä¾›ç»å¯¹ä½ç½®ä¿¡æ¯ã€‚åœ¨æ¨ç†ä¸­ï¼ŒAttentionæ¨¡å—è®¡ç®—çš„æ˜¯Qå’ŒKçš„ç‚¹ç§¯ï¼Œè€ŒPEæ˜¯ç›´æ¥åŠ åˆ°embeddingä¸Šï¼Œè¿™ä½¿å¾—**æ¨¡å‹è¦å­¦ä¹ å¦‚ä½•å°†ç»å¯¹ä½ç½®è½¬æ¢ä¸ºç›¸å¯¹ä½ç½®ä¿¡æ¯**ï¼Œå¢åŠ äº†å­¦ä¹ è´Ÿæ‹…ã€‚

åŒæ—¶ï¼Œè™½ç„¶å®ƒåœ¨ç†è®ºä¸Šå¯ä»¥æ— é™å»¶ä¼¸åˆ°ä»»æ„é•¿åº¦çš„åºåˆ—ï¼Œä½†åœ¨è®­ç»ƒæ—¶åªè§è¿‡çŸ­åºåˆ—ï¼Œå¯¹åº”çš„PEå‘é‡æ˜¯ä½é¢‘ä¸ºä¸»ã€‚å½“æ¨ç†æ—¶è¾“å…¥è¶…é•¿å¥å­ï¼ˆå¦‚ GPT-2è®­ç»ƒé•¿åº¦ä¸º1024ï¼Œæ¨ç†è¾“å…¥4096ï¼‰ï¼Œä½ç½®ç¼–ç å¯¹åº”çš„é¢‘ç‡æé«˜ï¼Œæ•°å€¼å˜åŒ–å‰§çƒˆï¼Œæ¨¡å‹ä¹‹å‰æ²¡æœ‰è§è¿‡è¿™äº›ä½ç½®æ¨¡å¼ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚

ä¸ºäº†åº”å¯¹è¿™äº›é—®é¢˜ï¼Œæ—‹è½¬ä½ç½®ç¼–ç (RoPE)è¢«æå‡ºã€‚

RoPEç»§æ‰¿äº†æ­£ä½™å¼¦ä½ç½®ç¼–ç çš„è¿œç¨‹è¡°å‡ç‰¹æ€§ï¼Œä½†æ˜¯é€šè¿‡å°†ç»å¯¹ä½ç½®ç¼–ç è½¬åŒ–ä¸ºqueryå’Œkeyçš„æ—‹è½¬æ“ä½œï¼Œ**å°†ä½ç½®å·®å¼‚â€œåµŒå…¥â€åˆ°æ³¨æ„åŠ›æœºåˆ¶çš„ç‚¹ç§¯ä¸­ï¼Œè½¬è€Œæ„ŸçŸ¥tokené—´çš„ç›¸å¯¹ä½ç½®å˜åŒ–**ã€‚è¿™ä¸€æœºåˆ¶å®è´¨ä¸Š**ä»¥ç»å¯¹ç¼–ç çš„å½¢å¼å®ç°äº†ç›¸å¯¹ä½ç½®æ„ŸçŸ¥èƒ½åŠ›**ï¼Œå¹¶ä¿æŒäº†è‰¯å¥½çš„å¯å¾®æ€§ä¸æ¨ç†æ•ˆç‡ï¼Œä¸”é€šè¿‡å‘¨æœŸæ€§çš„æ—‹è½¬å¯ä»¥å¹³æ»‘å¤–æ¨åˆ°ä»»æ„åºåˆ—é•¿åº¦ã€‚

**ä¸€å¥è¯æ€»ç»“ RoPE çš„æœ¬è´¨è´¡çŒ®ï¼š**  
> **RoPEä»¥ç»å¯¹ä½ç½®ç¼–ç çš„æ–¹å¼å®ç°äº†ç›¸å¯¹ä½ç½®ç¼–ç ï¼Œä»è€Œæå‡äº†Transformeræ¨¡å‹å¯¹é•¿åºåˆ—ä¸­ç›¸å¯¹ä½ç½®å˜åŒ–çš„æ•æ„Ÿæ€§å’Œç»“æ„å»ºæ¨¡èƒ½åŠ›ã€‚**

åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†è®²è§£RoPEçš„å†…å®¹ï¼Œæ¬¢è¿æŒç»­å…³æ³¨ã€‚

> #### å››ã€ç»å¯¹ä½ç½®ç¼–ç å’Œç›¸å¯¹ä½ç½®ç¼–ç  (new)
ä½†æ˜¯sin PEå’ŒRoPEä»ä¸€äº›è§’åº¦æ¥è¯´ï¼Œåº”è¯¥éƒ½æ˜¯â€œä»¥ç»å¯¹ä½ç½®ç¼–ç çš„æ–¹å¼å®ç°äº†ç›¸å¯¹ä½ç½®ç¼–ç â€çš„ç±»å‹å§ï¼Ÿ  

é‚£ä¹ˆï¼Œå®ƒä»¬çš„å·®åˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼ŸRoPEçš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿï¼ˆä¸‹ç« åˆ†æï¼‰

## 3. ç›¸å¯¹ä½ç½®ç¼–ç 
**transformer decoder inferenceé˜¶æ®µ**å¸¸ç”¨[KV Cache](https://zhuanlan.zhihu.com/p/662498827)    

ä½†æ˜¯[ç›¸å¯¹ä½ç½®ç¼–ç ä¸é€‚åˆKV Cache](https://cloud.tencent.com/developer/article/2403895)
